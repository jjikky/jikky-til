## ë‚ ì§œ: 2024-06-03

### ìŠ¤í¬ëŸ¼

-   ëª©í‘œ 1 : 8ì£¼ì°¨ ê³¼ì œ 1,2,3

### ê³µë¶€í•œ ë‚´ìš©

### ì£¼ì œ 1: ì¢‹ì•„ìš” ì €ì¥ ë° ì¢‹ì•„ìš” count ìµœì í™”

íŠ¹ì • ê²Œì‹œê¸€ì˜ ì¢‹ì•„ìš” ìˆ˜ë¥¼

```sql
SELECT COUNT(*) AS like_count
FROM LIKES
WHERE post_id = 1;
```

ì´ì™€ ê°™ì€ ì¿¼ë¦¬ë¡œ êµ¬í•˜ëŠ” ê²ƒê³¼ ê²Œì‹œê¸€ í…Œì´ë¸”ì— `count_like`ë¥¼ ì—…ë°ì´íŠ¸ í•´ì£¼ê³  ê·¸ ê°’ì„ ê°€ì ¸ì˜¤ëŠ” ê²ƒ ì¤‘ì— ë” íš¨ìœ¨ ì ì¸ ê²ƒì€ ë¬´ì—‡ì¼ê¹Œ?

### ì‹¤ì‹œê°„ ì¡°íšŒ

```sql
SELECT COUNT(*) AS like_count
FROM LIKES
WHERE post_id = 1;
```

-   ì¥ì 
    -   í•­ìƒ ìµœì‹  ë°ì´í„°ë¥¼ ì¡°íšŒ ê°€ëŠ¥
    -   ìŠ¤í‚¤ë§ˆì™€ ë¡œì§ì´ ë‹¨ìˆœí•´ì§. ì¢‹ì•„ìš” ìˆ˜ ë³„ë„ ê´€ë¦¬í•  í•„ìš” x
-   ë‹¨ì 
    -   ì¢‹ì•„ìš” ìˆ˜ë¥¼ ì¡°íšŒí•  ë•Œë§ˆë‹¤ `LIKES` í…Œì´ë¸”ì„ ìŠ¤ìº” í•´ì•¼í•¨ â†’ ë°ì´í„° ë§ì•„ì§€ë©´ ì„±ëŠ¥ ì €í•˜ ìš°ë ¤

### ê²Œì‹œê¸€ í…Œì´ë¸”ì— ì—…ë°ì´íŠ¸

`POSTS` í…Œì´ë¸”ì— ì¢‹ì•„ìš” ìˆ˜ë¥¼ ë¯¸ë¦¬ ê³„ì‚°í•´ì„œ ì €ì¥í•˜ëŠ” ê²½ìš°

-   ì¥ì 
    -   ì¢‹ì•„ìš” ìˆ˜ë¥¼ ì¡°íšŒí•  ë•Œ ë‹¨ì¼ í–‰ì„ ì½ê¸°ë§Œ í•˜ë©´ ë˜ë¯€ë¡œ ë§¤ìš° ë¹ ë¦„
    -   ì¡°íšŒ ë¹„ìš© ê°ì†Œ
-   ë‹¨ì 
    -   ì¢‹ì•„ìš”ë¥¼ ì¶”ê°€/ì‚­ì œí•  ë•Œë§ˆë‹¤ `POSTS` í…Œì´ë¸”ì„ ì—…ë°ì´íŠ¸í•´ì•¼ í•˜ë¯€ë¡œ, íŠ¸ëœì­ì…˜ ê´€ë¦¬ê°€ ë³µì¡í•´ì§ˆ ìˆ˜ ìˆìŒ
    -   ë¡œì§ ë³µì¡í•´ì§. ì˜ëª»ëœ ì—…ë°ì´íŠ¸ ë°œìƒ ê°€ëŠ¥ì„±

### ê²°ë¡ 

-   ì¡°íšŒ ì„±ëŠ¥ì´ ë§¤ìš° ì¤‘ìš”í•œ ê²½ìš°
    -   `POSTS` í…Œì´ë¸”ì— `count_like` í•„ë“œë¥¼ ì¶”ê°€í•˜ì—¬ ì¢‹ì•„ìš” ìˆ˜ë¥¼ ë¯¸ë¦¬ ê³„ì‚°í•´ì„œ ì €ì¥, ë‹¨ íŠ¸ëœì­ì…˜ ê´€ë¦¬ ë¹¡ì„¸ê²Œ
-   ë°ì´í„° ì •í™•ì„±(ì¼ê´€ì„±)ì´ ë§¤ìš° ì¤‘ìš”í•œ ê²½ìš°
    -   ì‹¤ì‹œê°„ ì¡°íšŒ ë°©ì‹ ì‚¬ìš©
-   ì •í™•ì„±ê³¼ ì„±ëŠ¥ì„ ëª¨ë‘ ê°œì„ í•˜ê¸° ìœ„í•´ ìºì‹± ì‚¬ìš©

### ìºì‹±ì„ í†µí•œ ì²˜ë¦¬

1. ì¢‹ì•„ìš” ìˆ˜ ì¡°íšŒ : ìºì‹œì— ì¢‹ì•„ìš” ìˆ˜ê°€ ìˆëŠ”ì§€ í™•ì¸
2. ìºì‹œ ì ì¤‘ : ìˆìœ¼ë©´ ë°˜í™˜
3. ìºì‹œ ë¯¸ìŠ¤ : ì—†ìœ¼ë©´ DBì—ì„œ ì¢‹ì•„ìš” ìˆ˜ ì¡°íšŒ í›„, ìºì‹œì— ì €ì¥ í›„ ë°˜í™˜
4. ì¢‹ì•„ìš” ì¶”ê°€/ì‚­ì œì‹œ : ìºì‹œì™€ DB ë™ì‹œì— ì—…ë°ì´íŠ¸

```jsx
const express = require('express');
const mysql = require('mysql2/promise');
const redis = require('redis');

const app = express();
const port = 3000;

const db = mysql.createPool({
    host: 'localhost',
    user: 'yourusername',
    password: 'yourpassword',
    database: 'yourdatabase',
});

const redisClient = redis.createClient();

redisClient.on('error', (err) => {
    console.error('Redis error:', err);
});

app.use(express.json());

app.get('/posts/:postId/likes', async (req, res) => {
    const postId = req.params.postId;

    try {
        redisClient.get(`post:${postId}:like_count`, async (err, likeCount) => {
            if (err) {
                return res.status(500).json({ error: 'Redis error' });
            }

            if (likeCount !== null) {
                return res.json({ like_count: parseInt(likeCount) });
            } else {
                const [rows] = await db.execute('SELECT count_like FROM POSTS WHERE post_id = ?', [postId]);
                likeCount = rows[0].count_like;
                redisClient.set(`post:${postId}:like_count`, likeCount);
                return res.json({ like_count: likeCount });
            }
        });
    } catch (error) {
        console.error('Database error:', error);
        res.status(500).json({ error: 'Database error' });
    }
});

app.post('/posts/:postId/like', async (req, res) => {
    const postId = req.params.postId;
    const userId = req.body.user_id;

    try {
        await db.execute('INSERT INTO LIKES (user_id, post_id) VALUES (?, ?)', [userId, postId]);
        await db.execute('UPDATE POSTS SET count_like = count_like + 1 WHERE post_id = ?', [postId]);
        redisClient.incr(`post:${postId}:like_count`);
        res.json({ message: 'Liked successfully' });
    } catch (error) {
        console.error('Database error:', error);
        res.status(500).json({ error: 'Database error' });
    }
});

app.delete('/posts/:postId/like', async (req, res) => {
    const postId = req.params.postId;
    const userId = req.body.user_id;

    try {
        await db.execute('DELETE FROM LIKES WHERE user_id = ? AND post_id = ?', [userId, postId]);
        await db.execute('UPDATE POSTS SET count_like = count_like - 1 WHERE post_id = ?', [postId]);
        redisClient.decr(`post:${postId}:like_count`);
        res.json({ message: 'Unliked successfully' });
    } catch (error) {
        console.error('Database error:', error);
        res.status(500).json({ error: 'Database error' });
    }
});

app.listen(port, () => {
    console.log(`Server is running on port ${port}`);
});
```

### ìºì‹œ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ íŠ¸ë¦¬ê±°ë‚˜ í”„ë¡œì‹œì €ë¥¼ ì¶”ê°€ + ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œ ìºì‹œ ì—…ë°ì´íŠ¸

**`LIKES` í…Œì´ë¸”ì— íŠ¸ë¦¬ê±° ì¶”ê°€**

**ì¢‹ì•„ìš” ì¶”ê°€ íŠ¸ë¦¬ê±°**

```sql
DELIMITER //

CREATE TRIGGER after_like_insert
AFTER INSERT ON LIKES
FOR EACH ROW
BEGIN
    UPDATE POSTS
    SET count_like = count_like + 1
    WHERE post_id = NEW.post_id;
END //

DELIMITER ;

```

**ì¢‹ì•„ìš” ì‚­ì œ íŠ¸ë¦¬ê±°**

```sql
DELIMITER //

CREATE TRIGGER after_like_delete
AFTER DELETE ON LIKES
FOR EACH ROW
BEGIN
    UPDATE POSTS
    SET count_like = count_like - 1
    WHERE post_id = OLD.post_id;
END //

DELIMITER ;
```

ì´ íŠ¸ë¦¬ê±°ëŠ” ì¢‹ì•„ìš” ìˆ˜ì˜ ì¼ê´€ì„±ì„ ìœ ì§€í•˜ë©´ì„œ ìë™ìœ¼ë¡œ `POSTS` í…Œì´ë¸”ì„ ì—…ë°ì´íŠ¸

### Express ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ

**ì¢‹ì•„ìš” ì¶”ê°€ API**

```jsx
app.post('/posts/:postId/like', async (req, res) => {
    const postId = req.params.postId;
    const userId = req.body.user_id;

    try {
        await db.execute('INSERT INTO LIKES (user_id, post_id) VALUES (?, ?)', [userId, postId]);

        // Redisì—ì„œ ì¢‹ì•„ìš” ìˆ˜ ì—…ë°ì´íŠ¸
        redisClient.incr(`post:${postId}:like_count`);

        res.json({ message: 'Liked successfully' });
    } catch (error) {
        console.error('Database error:', error);
        res.status(500).json({ error: 'Database error' });
    }
});
```

```jsx
app.delete('/posts/:postId/like', async (req, res) => {
    const postId = req.params.postId;
    const userId = req.body.user_id;

    try {
        await db.execute('DELETE FROM LIKES WHERE user_id = ? AND post_id = ?', [userId, postId]);

        // Redisì—ì„œ ì¢‹ì•„ìš” ìˆ˜ ì—…ë°ì´íŠ¸
        redisClient.decr(`post:${postId}:like_count`);

        res.json({ message: 'Unliked successfully' });
    } catch (error) {
        console.error('Database error:', error);
        res.status(500).json({ error: 'Database error' });
    }
});
```

### ì˜¤ëŠ˜ì˜ ì´ìŠˆì™€ í•´ê²° ë°©ë²•

-   íŠ¸ëœì­ì…˜ì„ í†µí•´ ì¼ê´€ì„± ìœ ì§€

**before code**

```sql
 const user_id = req.user.user_id;

        // ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
        const userSql = 'SELECT * FROM USERS WHERE user_id = ? AND deleted_at IS NULL';
        const [users] = await db.execute(userSql, [user_id]);

        if (users.length === 0) {
            return next(new appError('User not found', 404));
        }

        // ì‚¬ìš©ì ë…¼ë¦¬ì  ì‚­ì œ
        const deleteUserSql = 'UPDATE USERS SET deleted_at = CURRENT_TIMESTAMP WHERE user_id = ?';
        await db.execute(deleteUserSql, [user_id]);

        // ì‚¬ìš©ìê°€ ì‘ì„±í•œ ê²Œì‹œê¸€ ë…¼ë¦¬ì  ì‚­ì œ
        const postImageSql = 'SELECT post_image FROM POSTS WHERE creator = ? AND deleted_at IS NULL';
        const [posts] = await db.execute(postImageSql, [user_id]);
        for (const post of posts) {
            const deletePostSql = 'UPDATE POSTS SET deleted_at = CURRENT_TIMESTAMP WHERE post_id = ?';
            await db.execute(deletePostSql, [post.post_id]);
        }

        req.logout(req.user, (err) => {
            if (err) {
                return next(err);
            }
            req.session.destroy(() => {
                res.status(200).json({
                    message: 'User Deleted Successfully',
                });
            });
        });
```

**after code**

```sql
exports.deleteUser = async (req, res, next) => {
    const connection = await db.getConnection();
    try {
        await connection.beginTransaction();
        const user_id = req.user.user_id;

        // ì‚¬ìš©ì ë…¼ë¦¬ì  ì‚­ì œ
        const deleteUserSql =
            'UPDATE USERS SET deleted_at = CURRENT_TIMESTAMP WHERE user_id = ? AND deleted_at IS NULL';
        const [result] = await connection.execute(deleteUserSql, [user_id]);

        if (result.affectedRows === 0) {
            await connection.rollback();
            return next(new appError('User not found', 404));
        }

        // ì‚¬ìš©ìê°€ ì‘ì„±í•œ ê²Œì‹œê¸€ ë…¼ë¦¬ì  ì‚­ì œ
        const postImageSql = 'SELECT post_image FROM POSTS WHERE creator = ? AND deleted_at IS NULL';
        const [posts] = await connection.execute(postImageSql, [user_id]);
        for (const post of posts) {
            const deletePostSql = 'UPDATE POSTS SET deleted_at = CURRENT_TIMESTAMP WHERE post_id = ?';
            await connection.execute(deletePostSql, [post.post_id]);
        }

        await connection.commit();

        req.logout(req.user, (err) => {
            if (err) {
                return next(err);
            }
            req.session.destroy(() => {
                res.status(200).json({
                    message: 'User Deleted Successfully',
                });
            });
        });
    } catch (err) {
        console.log(err);
        return next(new appError('Internal Server Error', 500));
    }
};

```

### ì˜¤ëŠ˜ í•œ ì‘ì—…

### FE

[Feature/mysql : BE DB ì´ì „ì— ë”°ë¥¸ ë°ì´í„° í˜•ì‹ ë³€ê²½ ì ìš© by jjikky Â· Pull Request #6 Â· 100-hours-a-week/5-jikky-kim-react-fe](https://github.com/100-hours-a-week/5-jikky-kim-react-fe/pull/6)

### BE

**JSON â†’ mySQL ì´ì „**

[Feature/mysql : json -> mysql ì €ì¥ì†Œ ë³€ê²½ by jjikky Â· Pull Request #4 Â· 100-hours-a-week/5-jikky-kim-express-be](https://github.com/100-hours-a-week/5-jikky-kim-express-be/pull/4)

**í”„ë¡œì íŠ¸ êµ¬ì¡° ë³€ê²½**

[ğŸ¨ service layer architecture ì ìš© by jjikky Â· Pull Request #5 Â· 100-hours-a-week/5-jikky-kim-express-be](https://github.com/100-hours-a-week/5-jikky-kim-express-be/pull/5)
